@page "/"
@using MyFinance.Web.DTOs
@inject HttpClient Http

<MudText Typo="Typo.h4" Class="mb-4">Dashboard Financeiro</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4 text-muted">Visão geral deste mês</MudText>

@if (_carregando)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (dashboard == null)
{
    <MudAlert Severity="Severity.Info">Nenhum dado encontrado. Cadastre uma conta e lançamentos.</MudAlert>
}
else
{
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="4">
            <MudPaper Class="p-4 d-flex flex-column align-center justify-center" Elevation="3">
                <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.subtitle2" Class="mt-2">Receitas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Success">@dashboard.TotalReceitas.ToString("C2")</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="p-4 d-flex flex-column align-center justify-center" Elevation="3">
                <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" Color="Color.Error" Size="Size.Large" />
                <MudText Typo="Typo.subtitle2" Class="mt-2">Despesas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Error">@dashboard.TotalDespesas.ToString("C2")</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="p-4 d-flex flex-column align-center justify-center" Elevation="3">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.subtitle2" Class="mt-2">Saldo do Mês</MudText>
                <MudText Typo="Typo.h5" Color="@(dashboard.SaldoTotal >= 0 ? Color.Primary : Color.Error)">
                    @dashboard.SaldoTotal.ToString("C2")
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="p-4" Elevation="3">
                <MudText Typo="Typo.h6" Class="mb-3">Onde gastei meu dinheiro?</MudText>

                @if (dashboard.DespesasPorCategoria.Any())
                {
                    <MudChart ChartType="ChartType.Donut"
                              Width="100%"
                              Height="300px"
                              InputData="@dataGrafico"
                              InputLabels="@labelsGrafico" />
                }
                else
                {
                    <MudText>Nenhuma despesa registrada neste mês.</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="p-4 d-flex align-center justify-center" Elevation="3" Style="height: 100%">
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    🚀 Em breve: Análise Tributária PJ
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private DashboardDto? dashboard;
    private bool _carregando = true;

    // Arrays que o MudChart exige
    private double[] dataGrafico = { };
    private string[] labelsGrafico = { };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _carregando = true;
            // 1. Pega a conta (Mesma lógica do Extrato)
            var contas = await Http.GetFromJsonAsync<List<ContaDto>>("api/Contas");

            if (contas != null && contas.Any())
            {
                var contaId = contas.First().Id;

                // 2. Chama a API do Dashboard
                dashboard = await Http.GetFromJsonAsync<DashboardDto>($"api/Dashboard/{contaId}");

                // 3. Prepara os dados pro Gráfico (O MudChart pede arrays de double e string)
                if (dashboard != null)
                {
                    dataGrafico = dashboard.DespesasPorCategoria.Select(x => (double)x.Valor).ToArray();
                    labelsGrafico = dashboard.DespesasPorCategoria.Select(x => x.Categoria).ToArray();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro dashboard: {ex.Message}");
        }
        finally
        {
            _carregando = false;
        }
    }
}