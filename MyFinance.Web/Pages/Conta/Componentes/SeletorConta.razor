@using MyFinance.Web.DTOs
@using MyFinance.Web.Services
@inject HttpClient Http
@inject FinanceStateService FinanceState

@inject PageStateService PageState
@implements IDisposable

<MudSelect T="Guid?"
           Label="Conta Ativa"
           Value="FinanceState.SelectedAccountId"
           ValueChanged="OnAccountSelected"
           Variant="Variant.Outlined"
           Margin="Margin.Dense"
           Dense="true"
           Class="max-z-index"
           Style="width: 200px; background-color: white; border-radius: 8px;">

    <MudSelectItem T="Guid?" Value="null">Todas as Contas</MudSelectItem>

    @if (_contas != null)
    {
        foreach (var conta in _contas)
        {
            <MudSelectItem T="Guid?" Value="@conta.Id">@conta.Nome</MudSelectItem>
        }
    }
</MudSelect>

@code {
    private List<ContaDto>? _contas;

    protected override async Task OnInitializedAsync()
    {
        // Busca as contas que você já tem cadastradas no banco
        await CarregarContas();

        PageState.OnCreateNewContaChanged += HandleContasChanged;
    }

    private async void HandleContasChanged()
    {
        await CarregarContas();
        StateHasChanged();
    } 

    public void Dispose()
    {
        PageState.OnCreateNewContaChanged -= HandleContasChanged;
    }

    private async Task CarregarContas()
    {
        var todasContas = await Http.GetFromJsonAsync<List<ContaDto>>("api/contas");

        if (todasContas != null)
        {
            _contas = todasContas.Where(c => c.Ativo).ToList();
        }
    }

    private void OnAccountSelected(Guid? id)
    {
        var nome = _contas?.FirstOrDefault(c => c.Id == id)?.Nome ?? "Todas as Contas";
        FinanceState.SetAccount(id, nome);
    }
}