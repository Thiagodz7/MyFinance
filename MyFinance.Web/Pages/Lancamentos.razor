@page "/lancamentos"
@using MyFinance.Web.DTOs
@using MyFinance.Web.Services
@inject HttpClient Http
@inject IDialogService DialogService
@inject MyFinance.Web.Services.PageStateService PageState
@inject ISnackbar Snackbar

@implements IDisposable
@inject FinanceStateService FinanceState

<MudText Typo="Typo.h4" Class="mb-4">Extrato</MudText>

@if (_carregando)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Carregando dados...</MudText>
}
else if (extrato == null)
{
    <MudAlert Severity="Severity.Warning">Nenhuma conta encontrada. Cadastre uma conta no banco de dados.</MudAlert>
}
else
{
    <MudPaper Class="p-4 mb-4 d-flex justify-space-between align-center" Elevation="3">
        <div>
            <MudText Typo="Typo.caption">Conta</MudText>
            <MudText Typo="Typo.h6">@extrato.NomeConta</MudText>
        </div>
        <div class="text-end">
            <MudText Typo="Typo.caption">Saldo Atual</MudText>
            <MudText Typo="Typo.h4" Color="@(extrato.SaldoAtual >= 0 ? Color.Success : Color.Error)">
                @extrato.SaldoAtual.ToString("C2")
            </MudText>
        </div>
    </MudPaper>

    <div class="d-flex justify-space-between align-center mb-4">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@(() => AbrirDialog(null))">
            Novo Lançamento
        </MudButton>
    </div>

    <MudTable Items="@extrato.Lancamentos" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Data</MudTh>
            <MudTh>Descrição</MudTh>
            <MudTh>Categoria</MudTh>
            <MudTh>Valor</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Data">@context.Data.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Descrição">@context.Descricao</MudTd>
            <MudTd DataLabel="Categoria">
                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                    @context.Categoria
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Valor">
                <MudText Color="@(context.Valor >= 0 ? Color.Success : Color.Error)">
                    @context.Valor.ToString("C2")
                </MudText>
            </MudTd>
            <MudTd DataLabel="Ações">
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Warning"
                               OnClick="@(() => AbrirDialog(context))" />

                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               OnClick="@(() => ConfirmarExclusao(context.Id))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private ExtratoDto? extrato;
    private bool _carregando = true;

    private async Task AbrirDialog(LancamentoDto? lancamentoParaEditar = null)
    {
        if (extrato == null) return;

        var parameters = new DialogParameters();
        parameters.Add("ContaId", extrato.ContaId);

        // Passa o objeto se for edição (ou null se for criação)
        parameters.Add("LancamentoEditar", lancamentoParaEditar);

        var title = lancamentoParaEditar == null ? "Novo Lançamento" : "Editar Lançamento";

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await DialogService.ShowAsync<LancamentoDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            // Recarrega lista e atualiza cabeçalho global
            await CarregarExtrato();
            FinanceState.SetAccount(FinanceState.SelectedAccountId, FinanceState.SelectedAccountName);
        }
    }

    private async Task CarregarExtrato()
    {
        try
        {
            _carregando = true;
            
            var idContaSelecionada = FinanceState.SelectedAccountId;
            if (idContaSelecionada != null)
            {
                extrato = await Http.GetFromJsonAsync<ExtratoDto>($"api/Contas/{idContaSelecionada}/extrato");
            }
            else
            {
                var contas = await Http.GetFromJsonAsync<List<ContaDto>>("api/Contas");

                if ((contas != null && contas.Any()))
                {
                    var contaId = contas.First().Id;
                    extrato = await Http.GetFromJsonAsync<ExtratoDto>($"api/Contas/{contaId}/extrato");
                    FinanceState.SetAccount(contaId, contas.First().Nome);
                }            
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro: {ex.Message}");
        }
        finally
        {
            _carregando = false;
        }
    }


    public void Dispose()
    {
        FinanceState.OnAccountChanged -= HandleAccountChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        PageState.SetTitle("Lançamentos");
        FinanceState.OnAccountChanged += HandleAccountChanged;
        await CarregarExtrato();
    }

    private async void HandleAccountChanged()
    {
        await InvokeAsync(async () =>
        {
            await CarregarExtrato();
            StateHasChanged();
        });
    }

    private async Task ConfirmarExclusao(Guid id)
    {
        // 1. Configura o Modal de Confirmação
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };
        var parameters = new DialogParameters<MudDialog>
        {
            { "ContentText", "Deseja realmente excluir este lançamento? Esta ação não pode ser desfeita." },
            { "ButtonText", "Excluir" },
            { "Color", Color.Error }
        };

        // 2. Abre o Modal (estamos usando um Dialog padrão do MudBlazor aqui para simplificar)
        var dialog = await DialogService.ShowMessageBox(
            "Atenção",
            "Deseja realmente excluir este lançamento?",
            yesText: "Excluir",
            cancelText: "Cancelar"
        );

        if (dialog == true)
        {
            await ExecutarExclusao(id);
        }
    }

    private async Task ExecutarExclusao(Guid id)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/Lancamentos/{id}");

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Lançamento excluído com sucesso!", Severity.Success);

                // 3. ATENÇÃO: Avisamos o sistema que a conta mudou para
                // o Dashboard e o Saldo no Header atualizarem!
                FinanceState.SetAccount(FinanceState.SelectedAccountId, FinanceState.SelectedAccountName);

                // 4. Recarrega a lista da página atual
                await CarregarExtrato();
            }
            else
            {
                Snackbar.Add("Erro ao excluir o lançamento.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro crítico: {ex.Message}", Severity.Error);
        }
    }
}