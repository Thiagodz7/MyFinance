@page "/"
@using MyFinance.Web.DTOs
@using MyFinance.Web.Services
@using MyFinance.Web.Shared
@inject HttpClient Http
@inject MyFinance.Web.Services.PageStateService PageState

@implements IDisposable
@inject FinanceStateService FinanceState

<MudText Typo="Typo.h4" Class="mb-4">Dashboard Financeiro</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4 text-muted">Visão geral deste mês</MudText>

@if (_carregando)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (dashboard == null)
{
    <MudAlert Severity="Severity.Info">Nenhum dado encontrado. Cadastre uma conta e lançamentos.</MudAlert>
}
else
{
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="4">
            <WidgetResumo Titulo="Receitas" Icone1="@Icons.Material.Filled.ArrowUpward"
                          Valor="@dashboard.TotalReceitas" CorIcone="Color.Success"
                          Tamanho="Size.Large" Tipo1="Typo.subtitle2" Tipo2="Typo.h5"
                          CorPadrao="Color.Success" CorError="Color.Error"></WidgetResumo>
        </MudItem>
        <MudItem xs="12" sm="4">
            <WidgetResumo Titulo="Despesas" Icone1="@Icons.Material.Filled.ArrowDownward"
                          Valor="@dashboard.TotalDespesas" CorIcone="Color.Error"
                          Tamanho="Size.Large" Tipo1="Typo.subtitle2" Tipo2="Typo.h5"
                          CorPadrao="Color.Error" CorError="Color.Error"></WidgetResumo>
        </MudItem>
        <MudItem xs="12" sm="4">
            <WidgetResumo Titulo="Lucro do Mês" Icone1="@Icons.Material.Filled.AccountBalanceWallet"
                          Valor="@dashboard.SaldoTotal" CorIcone="Color.Primary"
                          Tamanho="Size.Large" Tipo1="Typo.subtitle2" Tipo2="Typo.h5"
                          CorPadrao="Color.Primary" CorError="Color.Error" Positivo="true"></WidgetResumo>
        </MudItem>
    </MudGrid>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="p-4" Elevation="3">
                <MudText Typo="Typo.h6" Class="mb-3">Onde gastei meu dinheiro?</MudText>

                @if (dashboard.DespesasPorCategoria.Any())
                {
                    <MudChart ChartType="ChartType.Donut"
                              Width="100%"
                              Height="300px"
                              InputData="@dataGrafico"
                              InputLabels="@labelsGrafico" />
                }
                else
                {
                    <MudText>Nenhuma despesa registrada neste mês.</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="p-4 d-flex align-center justify-center" Elevation="3" Style="height: 100%">
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    🚀 Em breve: Análise Tributária PJ
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private DashboardDto? dashboard;
    private bool _carregando = true;

    // Arrays que o MudChart exige
    private double[] dataGrafico = { };
    private string[] labelsGrafico = { };

    public void Dispose()
    {
        FinanceState.OnAccountChanged -= HandleAccountChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        PageState.SetTitle("Dashboard");
        FinanceState.OnAccountChanged += HandleAccountChanged;
        await CarregarDadosDashboard();   
    }

    private async void HandleAccountChanged()
    {
        await InvokeAsync(async () =>
        {
            await CarregarDadosDashboard();
            StateHasChanged();
        });
    }

    public async Task CarregarDadosDashboard()
    {
        try
        {
            _carregando = true;

            // LÓGICA CORRIGIDA:
            // Prioriza o ID selecionado no Global State. Se for nulo, busca a primeira.
            Guid? idParaBuscar = FinanceState.SelectedAccountId;

            if (idParaBuscar == null)
            {
                var contas = await Http.GetFromJsonAsync<List<ContaDto>>("api/Contas");
                if (contas != null && contas.Any())
                {
                    idParaBuscar = contas.Last().Id;
                    // Opcional: Já define essa como a conta ativa no estado global
                    // FinanceState.SetAccount(idParaBuscar, contas.First().Nome);
                }
            }

            if (idParaBuscar != null)
            {
                dashboard = await Http.GetFromJsonAsync<DashboardDto>($"api/Dashboard/{idParaBuscar}");

                if (dashboard != null)
                {
                    dataGrafico = dashboard.DespesasPorCategoria.Select(x => (double)x.Valor).ToArray();
                    labelsGrafico = dashboard.DespesasPorCategoria.Select(x => x.Categoria).ToArray();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro dashboard: {ex.Message}");
        }
        finally
        {
            _carregando = false;
        }
    }
}