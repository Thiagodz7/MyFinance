@inherits LayoutComponentBase
@using MyFinance.Web.Pages.Conta.Componentes
@using MyFinance.Web.Themes
@inject MyFinance.Web.Services.PageStateService PageState
@inject MyFinance.Web.Services.FinanceStateService FinanceState

@implements IAsyncDisposable
@inject IBrowserViewportService ViewportService
@implements IBrowserViewportObserver

<MudThemeProvider Theme="MyFinanceTheme.DefaultTheme" />
<MudDialogProvider />
<MudPopoverProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="@(_isMobile ? DrawerClipMode.Always : DrawerClipMode.Never)"
               Elevation="0"
               Variant="@(_isMobile ? DrawerVariant.Temporary : DrawerVariant.Mini)"
               Fixed="true">

        <MudDrawerHeader Class="@(_drawerOpen ? "d-flex align-center justify-start pa-4" : "d-flex align-center justify-center pa-2")">
            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Secondary" Size="Size.Large" Class="@(_drawerOpen ? "mr-2" : "")" />
            @if (_drawerOpen)
            {
                <MudText Typo="Typo.h5" Style="font-weight: 700; color: white;">MyFinance</MudText>
            }
        </MudDrawerHeader>

        <MudNavMenu Class="mt-4" Color="Color.Secondary">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/lancamentos" Icon="@Icons.Material.Filled.List">Lançamentos</MudNavLink>
            <MudNavLink Href="/relatorios" Icon="@Icons.Material.Filled.PieChart">Relatórios</MudNavLink>
            @if (_drawerOpen)
            {
                <MudText Typo="Typo.subtitle2" Class="px-4 mt-6 mb-2" Style="color: #64748B;">CONFIGURAÇÕES</MudText>
            }

            <MudNavLink Href="/contas" Icon="@Icons.Material.Filled.AccountBalance">Contas Bancárias</MudNavLink>
            <MudNavLink Href="/categorias" Icon="@Icons.Material.Filled.Category">Categorias</MudNavLink>
        </MudNavMenu>

        <div class="d-flex justify-center mt-auto mb-4">
            @* Melhoria: Texto de versão dinâmico para não quebrar no modo Mini *@
            <MudText Typo="Typo.caption" Style="color: #64748B;">
                @(_drawerOpen ? "v1.0.0" : "v1.0")
            </MudText>
        </div>

    </MudDrawer>


    <MudAppBar Elevation="1" Dense="false" Fixed="true" Color="Color.Surface" Class="px-4">
        <MudIconButton Icon="@(_drawerOpen? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@((e) => DrawerToggle())" />

        <MudText Typo="Typo.h6" Class="ml-3 fw-bold" Style="color: #1E293B;">
            @PageState.Title
        </MudText>

        <MudSpacer />

        <div class="mr-4">
            <SeletorConta></SeletorConta>
        </div>

        <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Default" />
    </MudAppBar>

    <MudMainContent Class="pt-16 px-4">
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = true;
    bool _isMobile;
    public Guid Id { get; } = Guid.NewGuid();

    protected override void OnInitialized()
    {
        PageState.OnTitleChanged += HandleTitleChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ViewportService.SubscribeAsync(this, fireImmediately: true);
        }
    }

    public async Task NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs e)
    {
        // 1. Atualizamos se é mobile baseado no Breakpoint do evento
        _isMobile = e.Breakpoint <= Breakpoint.Sm;

        // 2. Ajustamos o menu: aberto no PC (Mini), fechado no Mobile (Temporary)
        // Usamos InvokeAsync para garantir que a UI entenda a mudança de estado
        await InvokeAsync(() =>
        {
            _drawerOpen = !_isMobile;
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync() => await ViewportService.UnsubscribeAsync(this);

    private void HandleTitleChanged() => StateHasChanged();

    public void Dispose()
    {
        PageState.OnTitleChanged -= HandleTitleChanged;
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
}